<?php

/**
 * @file
 * Contains UC Tejarat Payment required hook implementations and callbacks.
 */

/**
 * Defines API version.
 */
define('UC_TEJARAT_API_VERSION', '3.1');

/**
 * Defines gateway default controller URI.
 */
define('UC_TEJARAT_GATEWAY_URI', 'https://pg.tejaratbank.net/paymentGateway/page');

/**
 * Defines gateway default SOAP Server URI.
 */
define('UC_TEJARAT_SOAP_URI', 'http://pg.tejaratbank.net/paymentGateway/services/merchant.wsdl');

/**
 * Defines test gateway default controller URI.
 */
define('UC_TEJARAT_TEST_GATEWAY_URI', 'http://pg.sabapardazesh.net:9085/paymentGateway/page');

/**
 * Defines test gateway default SOAP Server URI.
 */
define('UC_TEJARAT_TEST_SOAP_URI', 'http://pg.sabapardazesh.net:9086/paymentGateway/services/merchant.wsdl');

/**
 * Implements hook_menu().
 */
function uc_tejarat_menu() {
  $items = array();

  $items['cart/tejarat/%'] = array(
    'title' => 'Order payment status',
    'page callback' => 'uc_tejarat_response',
    'page arguments' => array(2),
    'access callback' => 'uc_tejarat_access',
    'file' => 'uc_tejarat.inc',
    'type' => MENU_CALLBACK,
  );

  return $items;
}

/**
 * Implements hook_payment_method().
 */
function uc_tejarat_payment_method() {
  $methods = array();

  $methods[] = array(
    'id' => 'tejarat',
    'name'  => t('Tejarat Bank'),
    'title' => t('Tejarat Bank'),
    'desc'  => t('Redirect to Tejarat bank payment gateway.'),
    'callback' => 'uc_tejarat_settings',
    'weight' => 1,
    'checkout' => TRUE,
    'no_gateway' => TRUE,
  );

  return $methods;
}

/**
 * Implements hook_form_alter() for uc_cart_checkout_review_form.
 *
 * Alters the order review form and injects required hidden fields,
 * also alteres its action attribute, addressing the Tejarat Bank gateway.
 */
function uc_tejarat_form_uc_cart_checkout_review_form_alter(&$form, $form_state) {
  $order_id = intval($_SESSION['cart_order']);
  // Check order identifier.
  if ($order_id > 0 && ($order = uc_order_load($order_id))) {
    // Alter the form if it's a Tejarat Bank payment.
    if ($order->payment_method == 'tejarat') {
      // Prepare the order object in form of Tejarat compatible data.
      if ($data = _uc_tejarat_prepare($order)) {
        // Inject hidden fields.
        _uc_tejarat_hidden_fields($data, $form);
        // And update the form action.
        $form['#action'] = variable_get('uc_tejarat_gateway_uri', UC_TEJARAT_GATEWAY_URI);
      }
      // Problems!
      else {
        // Notify customer.
        drupal_set_message(t('There were a problem preparing your order for Tejarat Bank payment. If possible, choose another payment method or try again later.'), 'error');
        // Notify the dog!
        watchdog(
          'uc_tejarat',
          'There were a problem preparing the order ID %order for Tejarat Bank payment.',
          array('%order' => $order->order_id),
          WATCHDOG_ERROR
        );
        // And return to checkout page.
        drupal_goto('cart/checkout');
      }
    }
  }
}

/**
 * Form callback for Ubercart Tejarat Bank Payment settings.
 */
function uc_tejarat_settings($op, &$arg1) {
  if ($op == 'settings') {
    $form = array();

    // Merchant code:
    $form['uc_tejarat_merchant_code'] = array(
      '#type' => 'textfield',
      '#title' => t('Merchant code'),
      '#description' => t('Enter the merchant code provided by Tejarat Bank.'),
      '#default_value' => variable_get('uc_tejarat_merchant_code', ''),
      '#required' => TRUE,
    );
    // Merchant password:
    $form['uc_tejarat_merchant_password'] = array(
      '#type' => 'textfield',
      '#title' => t('Merchant password'),
      '#description' => t('Enter the merchant password provided by Tejarat Bank.'),
      '#default_value' => variable_get('uc_tejarat_merchant_password', ''),
      '#required' => TRUE,
    );

    // Gateway URI settings:
    $form['additional'] = array(
      '#type' => 'fieldset',
      '#title' => t('Additional options'),
      '#collapsible' => TRUE,
      '#collapsed' => TRUE,
    );
    // Tejarat Bank gateway address:
    $form['additional']['uc_tejarat_gateway_uri'] = array(
      '#type' => 'textfield',
      '#title' => t('Tejarat gateway URI'),
      '#description' => t('Do not change the default value unless you checked the Tejarat bank docs and it has changed.'),
      '#default_value' => variable_get('uc_tejarat_gateway_uri', UC_TEJARAT_GATEWAY_URI),
      '#required' => TRUE,
    );
    // Tejarat Bank SOAP endpoint address:
    $form['additional']['uc_tejarat_soap_uri'] = array(
      '#type' => 'textfield',
      '#title' => t('Tejarat SOAP Server URI'),
      '#description' => t('Do not change the default value unless you checked the Tejarat bank docs and it has changed.'),
      '#default_value' => variable_get('uc_tejarat_soap_uri', UC_TEJARAT_SOAP_URI),
      '#required' => TRUE,
    );

    return $form;
  }
}

/**
 * Form validation callback for settings form.
 */
function uc_paypaad_settings_validate($form, &$form_state) {
  // Check for a numeric merchant code.
  if (!ctype_digit($form_state['values']['uc_tejarat_merchant_code'])) {
    form_set_error('uc_tejarat_merchant_code', t('Tejarat bank merchant code must be a valid numeric value.'));
  }
}

/**
 * Menu routes access callback.
 *
 * Ensures a free access to defined menu paths.
 */
function uc_tejarat_access() {
  return TRUE;
}

/**
 * Internal helper that builds Tejarat compatible data out of an UC order object.
 *
 * @param $order
 *   Ubercart order object.
 *
 * @return
 *   Either an array representation of data as per required by
 *   Tejarat Bank gateway or FALSE on operation failure.
 */
function _uc_tejarat_prepare($order) {
  // Partially check requirements.
  if (!is_object($order) || !variable_get('uc_tejarat_merchant_code', FALSE)) {
    return FALSE;
  }

  global $base_root;
  // Build and return the data array out of the $order.
  return array(
    'customerId' => $order->uid,
    'paymentId'  => $order->order_id,
    'amount' => round($order->order_total),
    'revertURL'  => $base_root . url('cart/tejarat'),
    'merchantId' => variable_get('uc_tejarat_merchant_code', ''),
  );
}

/**
 * Internal helper that injects required hidden fields to the passed form array.
 *
 * @param $data
 *   Array representation of required data.
 * @param $form
 *   Form (sub)array.
 *
 * @return
 *   Field injected form (sub)array.
 */
function _uc_tejarat_hidden_fields($data, &$form = array()) {
  foreach ($data as $key => $value) {
    $form[$key] = array(
      '#type' => 'hidden',
      '#value' => $value,
    );
  }
}
